#!/bin/bash
# Git post-merge hook - 拉取代码后自动处理迁移
# 适配本地开发环境

set -e

echo "🔄 检测到代码更新，自动处理迁移..."

# 获取项目根目录
PROJECT_ROOT=$(git rev-parse --show-toplevel)
BACKEND_DIR="$PROJECT_ROOT/backend"

# 切换到 backend 目录
cd "$BACKEND_DIR"

# 检查迁移文件是否有变化
MIGRATION_CHANGED=$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep "migrations/" || true)

if [ ! -z "$MIGRATION_CHANGED" ]; then
    echo "📝 检测到迁移文件变化:"
    echo "$MIGRATION_CHANGED"
    echo ""

    # 尝试执行迁移
    echo "🚀 正在执行数据库迁移..."
    python manage.py migrate --noinput 2>&1
    MIGRATE_RESULT=$?

    # 如果迁移失败，尝试自动合并
    if [ $MIGRATE_RESULT -ne 0 ]; then
        echo "⚠️  检测到迁移冲突，尝试自动合并..."
        python manage.py makemigrations --merge --noinput

        if [ $? -eq 0 ]; then
            echo "✅ 迁移合并成功，正在执行..."
            python manage.py migrate --noinput

            if [ $? -eq 0 ]; then
                echo "✅ 迁移完成！"
                echo "📝 注意：已自动生成合并迁移文件，请记得提交"
            else
                echo "❌ 迁移执行失败，请手动检查"
                exit 1
            fi
        else
            echo "❌ 自动合并失败，请手动执行: python manage.py makemigrations --merge"
            exit 1
        fi
    else
        echo "✅ 迁移完成！"
    fi
else
    echo "✅ 没有迁移文件变更"
fi

echo "✅ 自动处理完成!"
