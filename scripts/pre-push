#!/bin/bash
# pre-push hook - æ¨é€å‰æ£€æŸ¥åˆ†æ”¯å‘½åè§„èŒƒ
# å®‰è£…: è¿è¡Œ scripts/install-git-hooks.sh è‡ªåŠ¨å®‰è£…

set -e

current_branch=$(git symbolic-ref --short HEAD)

echo "ğŸ” æ£€æŸ¥åˆ†æ”¯å‘½åè§„èŒƒ..."

# å…è®¸çš„åˆ†æ”¯å‘½åæ ¼å¼
# 1. æ ‡å‡†æ ¼å¼: feature/xxx, fix/xxx, refactor/xxx, test/xxx, docs/xxx, hotfix/xxx
# 2. ä¿æŠ¤åˆ†æ”¯: main, develop, production
# 3. å†å²é—ç•™åˆ†æ”¯è±å…: äº§å“æ ‘-æˆ‘çš„å·¥ä½œåˆ†æ”¯, merge-infrastructure-improvements, public_patent_db ç­‰

# æ£€æŸ¥æ˜¯å¦ä¸ºæ ‡å‡†å‘½åæ ¼å¼
if echo "$current_branch" | grep -qE '^(feature|fix|refactor|test|docs|hotfix|release)/[a-z0-9-]+$'; then
    echo "âœ… åˆ†æ”¯å‘½åç¬¦åˆè§„èŒƒ: $current_branch"
    exit 0
fi

# æ£€æŸ¥æ˜¯å¦ä¸ºä¿æŠ¤åˆ†æ”¯
if echo "$current_branch" | grep -qE '^(main|develop|production)$'; then
    echo "âœ… ä¿æŠ¤åˆ†æ”¯: $current_branch"
    exit 0
fi

# å†å²é—ç•™åˆ†æ”¯è±å…åˆ—è¡¨
legacy_branches="äº§å“æ ‘-æˆ‘çš„å·¥ä½œåˆ†æ”¯|äº§å“æ ‘-æˆ‘çš„å·¥ä½œåˆ†æ”¯-merge-fix|merge-infrastructure-improvements|public_patent_db|mornitor_process|producttree-merge-fixing|äº§å“"

if echo "$current_branch" | grep -qE "^($legacy_branches)$"; then
    echo "âš ï¸  å†å²é—ç•™åˆ†æ”¯ï¼ˆè±å…ï¼‰: $current_branch"
    echo "   å»ºè®®: æœªæ¥è¯·ä½¿ç”¨æ ‡å‡†å‘½åæ ¼å¼"
    exit 0
fi

# æ£€æŸ¥æ˜¯å¦ä¸ºå¤‡ä»½åˆ†æ”¯ï¼ˆå…è®¸ä½†è­¦å‘Šï¼‰
if echo "$current_branch" | grep -qE '^backup-'; then
    echo "âš ï¸  å¤‡ä»½åˆ†æ”¯: $current_branch"
    echo "   å»ºè®®: å¤‡ä»½åˆ†æ”¯åº”åŠæ—¶æ¸…ç†"
    exit 0
fi

# ä¸ç¬¦åˆè§„èŒƒçš„åˆ†æ”¯
echo ""
echo "âŒ åˆ†æ”¯å‘½åä¸ç¬¦åˆè§„èŒƒ: $current_branch"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "å…è®¸çš„åˆ†æ”¯å‘½åæ ¼å¼ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  ğŸ“Œ æ ‡å‡†æ ¼å¼ï¼š"
echo "     feature/xxx    - æ–°åŠŸèƒ½åˆ†æ”¯"
echo "     fix/xxx        - Bugä¿®å¤åˆ†æ”¯"
echo "     refactor/xxx   - é‡æ„åˆ†æ”¯"
echo "     test/xxx       - æµ‹è¯•åˆ†æ”¯"
echo "     docs/xxx       - æ–‡æ¡£åˆ†æ”¯"
echo "     hotfix/xxx     - ç´§æ€¥ä¿®å¤åˆ†æ”¯"
echo ""
echo "  ğŸ“Œ ä¿æŠ¤åˆ†æ”¯ï¼š"
echo "     main           - ä¸»å¼€å‘åˆ†æ”¯"
echo "     develop        - å¼€å‘é›†æˆåˆ†æ”¯"
echo "     production     - ç”Ÿäº§ç¯å¢ƒåˆ†æ”¯"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ç¤ºä¾‹ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  âœ… feature/product-tree-visualization"
echo "  âœ… fix/migration-conflict"
echo "  âœ… refactor/api-service"
echo "  âœ… test/unit-tests"
echo "  âœ… docs/readme-update"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âš ï¸  å¦‚éœ€ç»§ç»­æ¨é€ï¼Œè¯·é‡å‘½ååˆ†æ”¯ï¼š"
echo ""
echo "   git branch -m $current_branch feature/your-feature-name"
echo ""
echo "æˆ–è·³è¿‡æ­¤æ£€æŸ¥ï¼ˆä¸æ¨èï¼‰ï¼š"
echo ""
echo "   git push --no-verify"
echo ""
exit 1
