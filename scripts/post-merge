#!/bin/bash
# Git post-merge hook - æ‹‰å–ä»£ç åè‡ªåŠ¨å¤„ç†
# å®‰è£…æ–¹æ³•: cp scripts/post-merge .git/hooks/ && chmod +x .git/hooks/post-merge

set -e

echo "ğŸ”„ æ£€æµ‹åˆ°ä»£ç æ›´æ–°ï¼Œè‡ªåŠ¨å¤„ç†ä¾èµ–å’Œè¿ç§»..."

# æ£€æŸ¥æ˜¯å¦åœ¨Dockerç¯å¢ƒä¸­
if [ -f /.dockerenv ]; then
    IN_DOCKER=true
else
    IN_DOCKER=false
fi

# æ£€æŸ¥è¿ç§»æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
MIGRATION_CHANGED=$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep "migrations/" || true)

if [ ! -z "$MIGRATION_CHANGED" ]; then
    echo "ğŸ“ æ£€æµ‹åˆ°è¿ç§»æ–‡ä»¶å˜åŒ–"

    # ğŸ”§ æ–°å¢ï¼šæ£€æµ‹è¿ç§»å†²çª
    if [ "$IN_DOCKER" = true ]; then
        CONFLICT_CHECK=$(python manage.py showmigrations --plan 2>&1 | grep -E "\\[X\\].*\\[X\\]" || true)
    else
        CONFLICT_CHECK=$(docker compose exec -T backend python manage.py showmigrations --plan 2>&1 | grep -E "\\[X\\].*\\[X\\]" || true)
    fi

    if [ ! -z "$CONFLICT_CHECK" ]; then
        echo "âš ï¸  æ£€æµ‹åˆ°è¿ç§»åºå·å†²çªï¼æ­£åœ¨è‡ªåŠ¨è§£å†³..."

        if [ "$IN_DOCKER" = true ]; then
            # åœ¨Dockerå†…éƒ¨ - è‡ªåŠ¨åˆå¹¶å†²çªçš„è¿ç§»
            python manage.py makemigrations --merge --noinput
        else
            # åœ¨ä¸»æœºä¸Š
            docker compose exec -T backend python manage.py makemigrations --merge --noinput
        fi

        echo "âœ… è¿ç§»å†²çªå·²è‡ªåŠ¨åˆå¹¶"
    fi

    # åº”ç”¨è¿ç§»
    if [ "$IN_DOCKER" = true ]; then
        # åœ¨Dockerå†…éƒ¨
        python manage.py migrate --noinput
    else
        # åœ¨ä¸»æœºä¸Š
        docker compose exec -T backend python manage.py migrate --noinput || {
            echo "âš ï¸  è¿ç§»å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†"
            echo "å»ºè®®è¿è¡Œ: docker compose exec backend bash scripts/fix_migrations.sh"
        }
    fi
fi

# æ£€æŸ¥package.jsonæ˜¯å¦æœ‰å˜åŒ–
PACKAGE_CHANGED=$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep "package.json" || true)

if [ ! -z "$PACKAGE_CHANGED" ]; then
    echo "ğŸ“¦ æ£€æµ‹åˆ°ä¾èµ–å˜åŒ–"

    if [ -d "frontend" ] && echo "$PACKAGE_CHANGED" | grep -q "frontend/package.json"; then
        cd frontend && npm install && cd ..
    fi
fi

echo "âœ… è‡ªåŠ¨å¤„ç†å®Œæˆ!"
