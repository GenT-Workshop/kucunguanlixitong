# 库存管理系统 - 权限系统说明文档

## 一、概述

本系统采用 **RBAC (Role-Based Access Control)** 基于角色的访问控制模型。

### 核心概念

| 概念 | 说明 |
|------|------|
| 权限 (Permission) | 最小的操作单元，如"查看入库"、"创建出库" |
| 角色 (Role) | 权限的集合，如"入库管理员"、"财务" |
| 用户 (User) | 系统使用者，可分配一个或多个角色 |

### 关系图

```
用户 (User)
    │
    ├── 用户角色关联 (UserRole)
    │
    ▼
角色 (Role)
    │
    ├── 角色权限关联 (RolePermission)
    │
    ▼
权限 (Permission)
```

---

## 二、数据库表结构

### 2.1 权限表 (Permission)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| code | varchar(100) | 权限标识，格式：`模块:操作` |
| name | varchar(100) | 权限名称 |
| module | varchar(50) | 所属模块 |

### 2.2 角色表 (Role)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| name | varchar(50) | 角色标识 |
| display_name | varchar(50) | 显示名称 |
| description | text | 角色描述 |
| is_active | boolean | 是否启用 |

### 2.3 角色权限关联表 (RolePermission)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| role_id | int | 角色ID (外键) |
| permission_id | int | 权限ID (外键) |

### 2.4 用户角色关联表 (UserRole)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| user_id | int | 用户ID (外键) |
| role_id | int | 角色ID (外键) |

---

## 三、权限列表

### 3.1 入库管理 (stock_in)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| stock_in:view | 查看入库 | 查看入库记录列表 |
| stock_in:create | 创建入库 | 新建入库单 |
| stock_in:delete | 删除入库 | 删除入库记录 |

### 3.2 出库管理 (stock_out)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| stock_out:view | 查看出库 | 查看出库记录列表 |
| stock_out:create | 创建出库 | 新建出库单 |
| stock_out:delete | 删除出库 | 删除出库记录 |

### 3.3 库存查询 (stock_query)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| stock_query:view | 查看库存 | 查看当前库存信息 |

### 3.4 库存预警 (stock_warning)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| stock_warning:view | 查看预警 | 查看库存预警列表 |
| stock_warning:check | 检查预警 | 执行预警检查 |

### 3.5 盘点管理 (stock_count)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| stock_count:view | 查看盘点 | 查看盘点记录 |
| stock_count:create | 创建盘点 | 新建盘点任务 |
| stock_count:submit | 提交盘点 | 提交盘点结果 |
| stock_count:complete | 完成盘点 | 确认盘点完成 |

### 3.6 统计分析 (statistics)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| statistics:view | 查看统计 | 查看统计报表 |

### 3.7 月底结存 (monthly_report)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| monthly_report:view | 查看月报 | 查看月度结存报表 |

### 3.8 用户管理 (user_manage)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| user_manage:view | 查看用户 | 查看用户列表 |
| user_manage:create | 创建用户 | 新建用户账号 |
| user_manage:update | 更新用户 | 修改用户信息 |
| user_manage:delete | 删除用户 | 删除用户账号 |

### 3.9 物料管理 (material)

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| material:view | 查看物料 | 查看物料列表 |
| material:create | 创建物料 | 新建物料 |
| material:update | 更新物料 | 修改物料信息 |

---

## 四、角色定义

### 4.1 入库管理员 (stock_in_admin)

**职责**：负责入库操作

**拥有权限**：
- stock_in:view, stock_in:create, stock_in:delete
- stock_query:view
- stock_warning:view

**可访问模块**：入库管理、库存查询、库存预警

### 4.2 出库管理员 (stock_out_admin)

**职责**：负责出库操作

**拥有权限**：
- stock_out:view, stock_out:create, stock_out:delete
- stock_query:view
- stock_warning:view

**可访问模块**：出库管理、库存查询、库存预警

### 4.3 仓库管理员 (warehouse_admin)

**职责**：负责仓库日常管理

**拥有权限**：
- stock_in:view, stock_in:create, stock_in:delete
- stock_out:view, stock_out:create, stock_out:delete
- stock_query:view
- stock_warning:view, stock_warning:check
- stock_count:view, stock_count:submit

**可访问模块**：入库管理、出库管理、库存查询、库存预警、盘点管理

### 4.4 财务 (finance)

**职责**：负责财务相关查询

**拥有权限**：
- stock_query:view
- stock_warning:view
- stock_count:view
- statistics:view
- monthly_report:view

**可访问模块**：库存查询、库存预警、盘点管理、统计分析、月底结存

### 4.5 老板 (boss)

**职责**：拥有所有权限

**拥有权限**：全部 22 个权限

**可访问模块**：全部模块

---

## 五、权限验证流程

### 5.1 用户登录时

```
1. 用户输入用户名密码
2. 后端验证身份
3. 查询 UserRole 表获取用户角色
4. 查询 RolePermission 表获取角色权限
5. 返回 modules 和 permissions 给前端
6. 前端存储到 localStorage
```

### 5.2 前端菜单显示

```javascript
// Dashboard.tsx
MODULES.filter((module) => {
  if (user?.role === '超级管理员') return true
  return user?.modules?.includes(module.module)
})
```

### 5.3 后端接口验证

```python
# 使用装饰器验证权限
@require_permission('stock_in:create')
def create_stock_in(request):
    # 只有拥有 stock_in:create 权限的用户才能访问
    pass
```

---

## 六、操作指南

### 6.1 给用户分配角色

1. 登录管理员账号
2. 进入「系统管理」→「用户管理」
3. 找到目标用户，点击「分配角色」
4. 选择要分配的角色
5. 点击确定保存

### 6.2 用户获取新权限

分配角色后，用户需要 **重新登录** 才能获取新的权限。

原因：权限数据在登录时获取并缓存到前端。

### 6.3 特殊用户

| 用户类型 | 说明 |
|----------|------|
| 超级管理员 (is_superuser=True) | 拥有所有权限，不受角色限制 |
| 管理员 (is_staff=True) | 可以访问用户管理功能 |

---

## 七、初始化命令

如果权限数据丢失，可以运行以下命令重新初始化：

```bash
cd backend
python manage.py init_permissions
```

该命令会创建：
- 22 个权限
- 5 个角色
- 角色权限关联

---

## 八、常见问题

### Q1: 分配角色后用户看不到对应功能？

**A**: 用户需要重新登录才能获取新权限。

### Q2: 如何给用户分配多个角色？

**A**: 在分配角色时可以选择多个角色，权限会自动合并。

### Q3: 超级管理员和普通管理员有什么区别？

**A**:
- 超级管理员 (is_superuser=True)：拥有所有权限
- 普通管理员 (is_staff=True)：只能访问用户管理，其他权限需要通过角色分配

---

*文档更新时间：2025-12-27*
